# Data Model: Constitution-Aware Textbook QA Bot

**Feature Branch**: `001-textbook-qa` | **Date**: 2025-11-30 | **Spec**: [specs/001-textbook-qa/spec.md](specs/001-textbook-qa/spec.md)
**Plan**: [specs/001-textbook-qa/plan.md](specs/001-textbook-qa/plan.md)

## Conceptual Data Model

This document outlines the key entities and their conceptual relationships within the Constitution-Aware Textbook QA Bot system. These entities represent the core data processed and managed by the RAG system.

### 1. User Query

Represents the natural language input provided by the user.

*   **Attributes**:
    *   `id`: Unique identifier for the query (UUID).
    *   `text`: The raw natural language string of the user's question.
    *   `timestamp`: Date and time when the query was received.
    *   `session_id` (optional): Identifier for a continuous conversation session.
*   **Validation**:
    *   `text` must not be empty.
    *   `text` length may be constrained (e.g., max 500 characters).

### 2. Source Document

Represents a piece of raw content that serves as a knowledge source for the chatbot. This includes the "Physical AI & Humanoid Robotics Textbook" and `constitution.md`.

*   **Attributes**:
    *   `id`: Unique identifier for the document (UUID).
    *   `name`: Display name of the document (e.g., "Physical AI Textbook", "Constitution").
    *   `type`: Categorization of the document (e.g., "TEXTBOOK", "CONSTITUTION").
    *   `content_raw`: The original, raw text content of the document.
    *   `last_indexed_at`: Timestamp of the last time this document was processed and indexed.
*   **Validation**:
    *   `content_raw` must not be empty.
    *   `type` must be one of predefined types.

### 3. Text Chunk

Represents a smaller, digestible segment of a `Source Document`, optimized for retrieval and embedding.

*   **Attributes**:
    *   `id`: Unique identifier for the chunk (UUID).
    *   `document_id`: Foreign key referencing the `Source Document` it belongs to.
    *   `text`: The textual content of the chunk.
    *   `embedding`: Vector representation of the `text` content (high-dimensional float array).
    *   `source_metadata`: Information to trace back to the original document (e.g., page number, chapter, section title, line numbers).
    *   `order_in_document`: Numerical order of the chunk within its `Source Document`.
*   **Relationships**:
    *   Many-to-one with `Source Document` (a document has many chunks).
*   **Validation**:
    *   `text` must not be empty.
    *   `embedding` must be a valid numerical vector.
    *   `source_metadata` should contain enough information for citation (FR-008).

### 4. Chatbot Response

Represents the output generated by the chatbot in response to a `User Query`.

*   **Attributes**:
    *   `id`: Unique identifier for the response (UUID).
    *   `query_id`: Foreign key referencing the `User Query` it answers.
    *   `text`: The natural language string of the chatbot's answer.
    *   `timestamp`: Date and time when the response was generated.
    *   `constitutional_compliance_status`: Status indicating adherence to `constitution.md` (e.g., "COMPLIANT", "FLAGGED", "NON_COMPLIANT").
    *   `cited_sources`: Array of references back to `Text Chunk` metadata (e.g., `document_id`, `source_metadata`).
*   **Relationships**:
    *   One-to-one with `User Query` (a query typically results in one response).
*   **Validation**:
    *   `text` must not be empty.
    *   `constitutional_compliance_status` must be valid.
    *   `cited_sources` should map to existing `Text Chunk` metadata.

### 5. Conversation Session (Optional)

Represents a continuous interaction thread between a user and the chatbot. Useful for context management in multi-turn conversations.

*   **Attributes**:
    *   `id`: Unique identifier for the session (UUID).
    *   `user_id` (optional): Identifier for the user.
    *   `start_timestamp`: Time when the session began.
    *   `last_activity_timestamp`: Time of the most recent interaction in the session.
    *   `context`: Stored information relevant to the session (e.g., previous turns, user preferences).
*   **Relationships**:
    *   One-to-many with `User Query` (a session can have many queries).

## Relationships Overview

*   `Source Document` 1 -- M `Text Chunk`
*   `User Query` 1 -- 1 `Chatbot Response`
*   `Conversation Session` 1 -- M `User Query` (optional)
*   `Chatbot Response` references `Text Chunk` (via `cited_sources`)

## Notes

- The primary storage for `Text Chunk` embeddings will be a Vector Database.
- The raw `Source Document` content may reside in a separate document store or file system.
